--- /var/ida/nextcloud-new/core/templates/layout.public.php	2024-11-05 08:30:08.259702233 +0000
+++ /var/ida/nextcloud-old/core/templates/layout.public.php	2024-02-20 10:11:39.209443037 +0000
@@ -1,11 +1,12 @@
 <?php
-/**
- * SPDX-FileCopyrightText: 2018-2024 Nextcloud GmbH and Nextcloud contributors
- * SPDX-License-Identifier: AGPL-3.0-or-later
- */
+function FDWEActive()
+{
+    return \OC::$server->getSystemConfig()->getValue('FDWE_URL', null) != null;
+}
 ?>
+
 <!DOCTYPE html>
-<html class="ng-csp" data-placeholder-focus="false" lang="<?php p($_['language']); ?>" data-locale="<?php p($_['locale']); ?>" translate="no" >
+<html class="ng-csp" data-placeholder-focus="false" lang="<?php p($_['language']); ?>" data-locale="<?php p($_['locale']); ?>" >
 <head data-requesttoken="<?php p($_['requesttoken']); ?>">
 	<meta charset="utf-8">
 	<title>
@@ -14,10 +15,9 @@
 p($theme->getTitle());
 ?>
 	</title>
-	<meta name="csp-nonce" nonce="<?php p($_['cspNonce']); /* Do not pass into "content" to prevent exfiltration */ ?>">
-	<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0<?php if (isset($_['viewport_maximum_scale'])) {
-		p(', maximum-scale=' . $_['viewport_maximum_scale']);
-	} ?>">
+	<script nonce="<?php p(\OC::$server->getContentSecurityPolicyNonceManager()->getNonce()) ?>" src="/core/js/jquery-2.2.4.js"></script>
+	<meta http-equiv="X-UA-Compatible" content="IE=edge">
+	<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0">
 	<?php if ($theme->getiTunesAppId() !== '') { ?>
 	<meta name="apple-itunes-app" content="app-id=<?php p($theme->getiTunesAppId()); ?>">
 	<?php } ?>
@@ -30,54 +30,52 @@
 	<link rel="apple-touch-icon" href="<?php print_unescaped(image_path($_['appid'], 'favicon-touch.png')); ?>">
 	<link rel="apple-touch-icon-precomposed" href="<?php print_unescaped(image_path($_['appid'], 'favicon-touch.png')); ?>">
 	<link rel="mask-icon" sizes="any" href="<?php print_unescaped(image_path($_['appid'], 'favicon-mask.svg')); ?>" color="<?php p($theme->getColorPrimary()); ?>">
-	<link rel="manifest" href="<?php print_unescaped(image_path($_['appid'], 'manifest.json')); ?>" crossorigin="use-credentials">
+	<link rel="manifest" href="<?php print_unescaped(image_path($_['appid'], 'manifest.json')); ?>">
 	<?php emit_css_loading_tags($_); ?>
 	<?php emit_script_loading_tags($_); ?>
 	<?php print_unescaped($_['headers']); ?>
+
+    <?php if (FDWEActive()) : ?>
+    <meta name="fdwe-service" content="IDA">
+    <?php if (strpos($_SERVER["REQUEST_URI"], "NOT_FOR_PUBLICATION") !== false ) : ?>
+    <meta name="fdwe-scope" content="FILES / SHARE / ACCESS">
+    <?php endif; ?>
+    <script nonce="<?php p(\OC::$server->getContentSecurityPolicyNonceManager()->getNonce()) ?>" src="<?php p(\OC::$server->getSystemConfig()->getValue('FDWE_URL')); ?>"></script>
+    <?php endif; ?>
 </head>
 <body id="<?php p($_['bodyid']);?>">
 	<?php include('layout.noscript.warning.php'); ?>
-	<?php include('layout.initial-state.php'); ?>
-	<div id="skip-actions">
-		<?php if ($_['id-app-content'] !== null) { ?><a href="<?php p($_['id-app-content']); ?>" class="button primary skip-navigation skip-content"><?php p($l->t('Skip to main content')); ?></a><?php } ?>
-		<?php if ($_['id-app-navigation'] !== null) { ?><a href="<?php p($_['id-app-navigation']); ?>" class="button primary skip-navigation"><?php p($l->t('Skip to navigation of app')); ?></a><?php } ?>
+<?php foreach ($_['initialStates'] as $app => $initialState) { ?>
+	<input type="hidden" id="initial-state-<?php p($app); ?>" value="<?php p(base64_encode($initialState)); ?>">
+<?php }?>
+	<div id="notification-container">
+		<div id="notification"></div>
 	</div>
-
 	<header id="header">
 		<div class="header-left">
-			<div id="nextcloud" class="header-appname">
-				<?php if ($_['logoUrl']): ?>
-					<a href="<?php print_unescaped($_['logoUrl']); ?>"
-					   aria-label="<?php p($l->t('Go to %s', [$_['logoUrl']])); ?>">
-						<div class="logo logo-icon"></div>
-					</a>
-				<?php else: ?>
-					<div class="logo logo-icon"></div>
-				<?php endif; ?>
-
-				<div class="header-info">
-					<span class="header-title">
+			<span id="nextcloud">
+				<div class="logo logo-icon svg"></div>
+				<h1 class="header-appname">
 						<?php if (isset($template) && $template->getHeaderTitle() !== '') { ?>
 							<?php p($template->getHeaderTitle()); ?>
 						<?php } else { ?>
 							<?php	p($theme->getName()); ?>
 						<?php } ?>
-					</span>
+				</h1>
 					<?php if (isset($template) && $template->getHeaderDetails() !== '') { ?>
-						<span class="header-shared-by">
+				<div class="header-shared-by">
 							<?php p($template->getHeaderDetails()); ?>
-						</span>
-					<?php } ?>
-				</div>
 			</div>
+				<?php } ?>
+			</span>
 		</div>
 
-		<div class="header-right">
 		<?php
 /** @var \OCP\AppFramework\Http\Template\PublicTemplateResponse $template */
 if (isset($template) && $template->getActionCount() !== 0) {
 	$primary = $template->getPrimaryAction();
 	$others = $template->getOtherActions(); ?>
+		<div class="header-right">
 			<span id="header-primary-action" class="<?php if ($template->getActionCount() === 1) {
 				p($primary->getIcon());
 			} ?>">
@@ -100,34 +98,16 @@
 				</div>
 			</div>
 			<?php } ?>
+		</div>
 		<?php
 } ?>
-		</div>
 	</header>
-	<main id="content" class="app-<?php p($_['appid']) ?>">
-		<h1 class="hidden-visually">
-			<?php if (isset($template) && $template->getHeaderTitle() !== '') { ?>
-				<?php p($template->getHeaderTitle()); ?>
-			<?php } else { ?>
-				<?php	p($theme->getName()); ?>
-			<?php } ?>
-		</h1>
+	<div id="content" class="app-<?php p($_['appid']) ?>" role="main">
 		<?php print_unescaped($_['content']); ?>
-	</main>
-	<?php if (isset($template) && $template->getFooterVisible() && ($theme->getLongFooter() !== '' || $_['showSimpleSignUpLink'])) { ?>
+	</div>
+	<?php if (isset($template) && $template->getFooterVisible()) { ?>
 	<footer>
 		<p><?php print_unescaped($theme->getLongFooter()); ?></p>
-		<?php
-if ($_['showSimpleSignUpLink']) {
-	?>
-			<p class="footer__simple-sign-up">
-				<a href="<?php p($_['signUpLink']); ?>" target="_blank" rel="noreferrer noopener">
-					<?php p($l->t('Get your own free account')); ?>
-				</a>
-			</p>
-			<?php
-}
-		?>
 	</footer>
 	<?php } ?>
 
